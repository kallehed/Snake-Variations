#include "game_state_Zelda.h"
#include "maze_stuff.h"
#include "player_related.h"
#include "raylib.h"
#include "snake_pather.h"
#include "very_general.h"

#include <math.h>
#include <stdio.h>
#include <stdlib.h>

void metagame_set_level_Zelda(Meta_Game *mg)
{
    mg->frame_code = (Meta_Game_Frame_Code)game_state_frame_Zelda;
    mg->init_code = (Meta_Game_Init_Code)game_state_init_Zelda;
    mg->size = (sizeof(GS_Zelda));
}

void game_state_init_Zelda(GS_Zelda *new_g)
{
    GS_Zelda g;
    g.w = world_state0_init_general(GS_ZELDA_WIDTH, GS_ZELDA_HEIGHT, WINDOW_WIDTH / GS_ZELDA_ROOM_WIDTH);
    g.player = player_init((Pos){.x = 5, .y = 5}, 2, Dir_Right);
	g.room_x = -1;
	g.room_y = -1;
	g.room_change_timer = 0.f;
    g.time_for_move = 0.0;

    const char *map[] = {
        "--------------------------------------------------------------------------------------|------------|",
        "--------------------------------------------------------------------------------------|------------|",
        "--------------------------------------------------------------------------------------|------------|",
        "--------------------------------------------------------------------------------------|------------|",
        "--------------------------------------------------------------------------------------|------------|",
        "--------------------------------------------------------------------------------------|------F-----|",
        "--------------------------------------------------------------------------------------|------------|",
        "--------------------------------------------------------------------------------------|------------|",
        "--------------------------------------------------------------------------------------|------------|",
        "--------------------------------------------------------------------------------------|------------|",
        "--------------------------------------------------------------------------------------||||||||||||||",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "--------------------------------------------------------------------------|-------------------------",
        "------------------------------------------------------------------------|||-------------------------",
        "-----------------------------------------------------------------------||||-------------------------",
        "---------------------------------------------------------------------||||||-------------------------",
        "--------------------------------------------------------------------|||||||-------------------------",
        "------------------------------------------------------------------|||||||||-------------------------",
        "---------------------------------------------------------------------------F------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "-----------------------------------|----------|-----------------------------------------------------",
        "-----------------------------------|----------|-----------------------------------------------------",
        "-----------------------------------|----------|-----------------------------------------------------",
        "-----------------------------------|----------|-----------------------------------------------------",
        "-----------------------------------|-----F----|-----------------------------------------------------",
        "-----------------------------------|----------|-----------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "---------------------------|||||||--------------||||||||--------------------------------------------",
        "----------------------------------|||||||||||||||---------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "S---------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "--------------------------|-------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "-----------------------------|----------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------|-----------------------------------------------------------------------",
        "----------------------------------|-----------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "------------------------------||||||||||||||||||||--------------------------------------------------",
        "------------------------------|-----------------S|--------------------------------------------------",
        "------------------------------|-||||||||||||||||-|--------------------------------------------------",
        "------------------------------|-|S----|---|----|-|-----------------------------S--------------------",
        "------------------------------|-|--||-|---|----|-|--------------------------------------------------",
        "------------------------------|-|--||-|---|----|-|--------------------------------------------------",
        "------------------------------|-|--||-|---|----|-|----------------------------------F---------------",
        "------------------------------|-|--||-|---|----|-|--------------------------------------------------",
        "------------------------------|-|--||-|---|----|-|--------------------------------------------------",
        "------------------------------|----||----------|-|--------------------------------------------------",
        "------------------------------|-|--||--------F-|---------------------------------------S------------",
        "------------------------------|----||----------|-|--------------------------------------------------",
        "------------------------------|-|--||-|---|----|-|--------------------------------------------------",
        "------------------------------|-|--||-|---|----|-|--------------------------------------------------",
        "------------------------------|-|--||-|---|----|-|--------------------------------------------------",
        "------------------------------|-|--||-|---|----|-|--------------------------------------------------",
        "------------------------------|-|-----|---|----|-|--------------------------------------------------",
        "------------------------------|-||||||||||||||||-|--------------------------------------------------",
        "------------------------------|------------------|--------------------------------------------------",
        "------------------------------||||||||||||||||||||--------------------------------------------------",
        "---S------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "------F---------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
        "----------------------------------------------------------------------------------------------------",
    };
    Int tail_lengths[GS_ZELDA_PATHERS];
    Dir tail_dirs[GS_ZELDA_PATHERS];

    Int p_idx = 0;
    {
        Snake_Pather_Way ways[] = {
            {.dir = Dir_Right, .len = 100},
        };

        tail_lengths[p_idx] = 30;
        tail_dirs[p_idx] = Dir_Left;
        g.pathers[p_idx++] = snake_pather_init_except_position(ways, 1);
    }
    {
        Snake_Pather_Way ways[] = {{.dir = Dir_Down, .len = 17},
                                   {.dir = Dir_Left, .len = 17},
                                   {.dir = Dir_Up, .len = 17},
                                   {.dir = Dir_Right, .len = 17}};

        tail_lengths[p_idx] = 18;
        tail_dirs[p_idx] = Dir_Left;
        g.pathers[p_idx++] = snake_pather_init_except_position(ways, 4);
    }
    {
        Snake_Pather_Way ways[] = {{.dir = Dir_Right, .len = 4},
                                   {.dir = Dir_Down, .len = 13},
                                   {.dir = Dir_Left, .len = 4},
                                   {.dir = Dir_Up, .len = 13}};

        tail_lengths[p_idx] = 6;
        tail_dirs[p_idx] = Dir_Down;
        g.pathers[p_idx++] = snake_pather_init_except_position(ways, 4);
    }
    {
        Snake_Pather_Way ways[] = {{.dir = Dir_Right, .len = 2},
                                   {.dir = Dir_Down, .len = 5},
                                   {.dir = Dir_Left, .len = 2},
                                   {.dir = Dir_Up, .len = 5}};

        tail_lengths[p_idx] = 3;
        tail_dirs[p_idx] = Dir_Down;
        g.pathers[p_idx++] = snake_pather_init_except_position(ways, 4);
    }
    {
        Snake_Pather_Way ways[] = {{.dir = Dir_Right, .len = 2},
                                   {.dir = Dir_Down, .len = 4},
                                   {.dir = Dir_Left, .len = 2},
                                   {.dir = Dir_Up, .len = 4}};

        tail_lengths[p_idx] = 3;
        tail_dirs[p_idx] = Dir_Down;
        g.pathers[p_idx++] = snake_pather_init_except_position(ways, 4);
    }
    {
        Snake_Pather_Way ways[] = {{.dir = Dir_Right, .len = 5},
                                   {.dir = Dir_Down, .len = 5},
                                   {.dir = Dir_Left, .len = 5},
                                   {.dir = Dir_Up, .len = 5}};

        tail_lengths[p_idx] = 10;
        tail_dirs[p_idx] = Dir_Left;
        g.pathers[p_idx++] = snake_pather_init_except_position(ways, 4);
    }

    maze0_init_from_string(map, GS_ZELDA_WIDTH, GS_ZELDA_HEIGHT, g.foods, (Maze0_Cell *)g.maze, g.pathers, tail_lengths,
                           tail_dirs, &g.w);

    *new_g = g;
}
// normal snake
Level_Return game_state_frame_Zelda(GS_Zelda *g)
{
    World_State0 *w = &g->w;
    // logic
    if (g->room_change_timer <= 0.f)
    {
        player_set_direction_from_input(&g->player);

        if (time_move_logic(&g->time_for_move))
        {
            if (maze0_player_move((Maze0_Cell *)g->maze, GS_ZELDA_WIDTH, &g->player, w))
            {
                // player died
                return Level_Return_Reset_Level;
            }
            {
                const Pos p_pos = player_nth_position(&g->player, 0);
                const Int room_x = p_pos.x / GS_ZELDA_ROOM_WIDTH;
                const Int room_y = p_pos.y / GS_ZELDA_ROOM_HEIGHT;
                if (room_x != g->room_x || room_y != g->room_y)
                {
                    if ((-1) != g->room_x)
                    {
						// not the first frame
						g->room_change_timer = GS_ZELDA_ROOM_CHANGE_TIME;
						g->prev_room_x = g->room_x;
						g->prev_room_y = g->room_y;
                    }
                    g->room_x = room_x;
                    g->room_y = room_y;
                }
            }

            for (Int i = 0; i < GS_ZELDA_PATHERS; ++i)
            {
                snake_pather_move(&g->pathers[i], w);
            }
            for (Int i = 0; i < GS_ZELDA_PATHERS; ++i)
            {
                if (snake_pather_player_intersection(&g->pathers[i], &g->player))
                {
                    return Level_Return_Reset_Level;
                }
            }
            for (Int i = 0; i < GS_ZELDA_FOODS; ++i)
            {
                food_player_collision_logic_food_disappear(&g->player, &g->foods[i]);
            }
        }
    }
    else
    {
        // cutscene from one room to another
		g->room_change_timer -= GetFrameTime();
    }
    Int food_left_to_win = (GS_ZELDA_FOODS + 2) - g->player.length;

    if (food_left_to_win <= 0)
        return Level_Return_Next_Level;

    // drawing
    BeginDrawing();
    {
        float cam_x, cam_y;
        cam_x = w->block_pixel_len * GS_ZELDA_ROOM_WIDTH *
                (g->room_x + (g->prev_room_x - g->room_x) * (g->room_change_timer / GS_ZELDA_ROOM_CHANGE_TIME));
        cam_y = w->block_pixel_len * GS_ZELDA_ROOM_HEIGHT *
                (g->room_y + (g->prev_room_y - g->room_y) * (g->room_change_timer / GS_ZELDA_ROOM_CHANGE_TIME));

        // printf("cam_x: %f, max_x: %f\n", cam_x, max_x);
        Camera2D s = (Camera2D){
            .offset = {.x = 0.f, .y = 0.f}, .target = {.x = cam_x, .y = cam_y}, .rotation = 0.f, .zoom = 1.f};
        BeginMode2D(s);
    }

    ClearBackground(RAYWHITE);
    maze0_draw((Maze0_Cell *)g->maze, GS_ZELDA_WIDTH, GS_ZELDA_HEIGHT, w);
    for (Int i = 0; i < GS_ZELDA_PATHERS; ++i)
    {
        snake_pather_draw(&g->pathers[i], w);
    }
    draw_food_left_in_2D_space(food_left_to_win, w->width * w->block_pixel_len, w->height * w->block_pixel_len);

    player_draw(&g->player, w);
    for (Int i = 0; i < GS_ZELDA_FOODS; ++i)
    {
        food_draw(&g->foods[i], w);
    }

    EndMode2D();
    draw_fps();
    EndDrawing();

    return Level_Return_Continue;
}
